<!DOCTYPE HTML>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
crossorigin="anonymous">
</head>

<body>         
<h1>Game</h1>
    
      <div class="row align-items-center container-fluid">
    
        <div class="col-lg-5" style="min-height: 400px; padding-left: 60px; border-style: solid">
          <h2>Timer</h2>
          <button onclick="startTimer()">Start</button>
          <button onclick="stopTimer()">Stop</button>
          <p id="demo"></p>

          <form class="form-save" action="/save" method="post">
            <input type="text" id="savedUsername">
            <div>Your Score: <p id="savedTime"></p></div>
            <div><button type='button' id="saveScore" class="btn btn-block text-white" style="background: #9243D3;">Save</button></div>         
         </form>
        </div>
    
        <div class="col-lg-7">
          <div class="rounded" style="padding-right: 30px; padding-left: 30px; margin-right:50px; margin-top: 40px;">
          <h3>Scores</h3>
          <table id="topscores">
            <col width="70"><col width="180"><col width="50">
            <tr>
                <th>Rank</th><th>Username</th> <th>Score</th>
              </tr>
              <table id="tablecontent">
                <col width="70"><col width="180"><col width="50">
                <!-- Easier to have 10 set rows rather than creating elements in javascript. Never going to have more than 10 and if less than 10 entries, remaining rows will just be blank. -->
                <tr><td>&nbsp;1</td><td id="u0"></td><td id="s0"></td></tr>                    
                <tr><td>&nbsp;2</td><td id="u1"></td><td id="s1"></td></tr>
                <tr><td>&nbsp;3</td><td id="u2"></td><td id="s2"></td></tr>
                <tr><td>&nbsp;4</td><td id="u3"></td><td id="s3"></td></tr>
                <tr><td>&nbsp;5</td><td id="u4"></td><td id="s4"></td></tr>
                <tr><td>&nbsp;6</td><td id="u5"></td><td id="s5"></td></tr>
                <tr><td>&nbsp;7</td><td id="u6"></td><td id="s6"></td></tr>
                <tr><td>&nbsp;8</td><td id="u7"></td><td id="s7"></td></tr>
                <tr><td>&nbsp;9</td><td id="u8"></td><td id="s8"></td></tr>
                <tr><td>10</td><td id="u9"></td><td id="s9"></td></tr>
              </table>
          </table>       
          </div>
        </div>
    
      </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
    $( document ).ready(function() { // On page load
        checkUpdate(); // Check the DB for scores
    });

    $(function() { // Refresh function, 
        setTimeout(checkUpdate, 1000); // setTimeout() allows execution of code at specified time intervals - 1000 milliseconds = 1 second, run checkUpdate() every second to check for new scores
    });

    function checkUpdate(){
        $.get("/getScoreList", function(data){
            d = JSON.parse(data); // Go to the getScoresList route, let d equal the data returned by the function
            for (var i = 0; i < d.length; i++) { // for loop, 0 to length of d (will either be 10 or less)
                var utag = "u" + i; // Generate a username tag string (row 3 = u3, s3)
                var stag = "s" + i; // Same as above except score tag
                var username = d[i].username; // Let username equal the i-th entry's username 
                var numScore = d[i].score; // Same except score
                var len = numScore.length; // length of the score string 
                var timeScore = numScore.substring(0, len-2) + ":" + numScore.substring(len-2); // Need to add the : back in to separate seconds from minutes - Create a new string of first element to third last element + : + the last two elements.

                if(document.getElementById(utag).innerHTML != username && document.getElementById(stag).innerHTML != timeScore){ // If the username AND score in the table row are NOT the same as the parsed in username and score, means top 10 has updated
                    document.getElementById(utag).innerHTML = username; // Update the relevant username cell
                    document.getElementById(stag).innerHTML = timeScore; // Same for score
                }
            }
        });
        setTimeout(checkUpdate, 1000); // Go back and check for updates continuously
    }


    var timerOn = 0;
    function timer() {
        if (timerOn == 1){
            // Set the time to count from - new Date() gets the current time
            var countDownDate = new Date().getTime();
            // Update the count down every 1 second
            x = setInterval(function() {
                // Get todays date and time
                var now = new Date().getTime();
                
                // Find the distance between now an the count down date
                var distance = now - countDownDate;
                
                // Time calculations for days, hours, minutes and seconds
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                // Output the result in an element with id="demo"
                document.getElementById("demo").innerHTML = minutes + ":" + pad(seconds, 2);
            }, 1000);
        }
    }

    function startTimer() {
        if (!timerOn) {
            timerOn = 1;
            timer();
        }
    }

    function stopTimer() {
        var time = document.getElementById("demo").innerHTML;
        document.getElementById("savedTime").innerHTML = time;
        clearTimeout(x);
        timerOn = 0;
        console.log(time);
    }

    // Pad seconds with 0s - adapted from https://stackoverflow.com/a/10073788/7232648
    function pad(n, width, z) {
    z = z || '0';
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
    }

    // Button click event
    $('#saveScore').click(function ( event ){
        event.preventDefault(); // Cancels default action of click - https://api.jquery.com/event.preventdefault/

        if(document.getElementById("savedUsername").value == ""){
            givenusername = "anon"; // If there's no username entered in the box just enter anon
        } else {
            givenusername = document.getElementById("savedUsername").value; // Otherwise use the specified name
        }
        var scoreSec = document.getElementById("savedTime").innerHTML; // Get the time from the timer
        var scoreNum = scoreSec.replace(":", ""); // Get rid of the :

        // User's data in json
        var scoreData = {
            username: givenusername,
            score: scoreNum,
        }
        scoreData = JSON.stringify(scoreData) // Turns whole json object into string
        console.log("html json: " + scoreData) // Making sure it's right
        
        // Adapted from https://stackoverflow.com/a/26930355/7232648
        $.ajax({
            url: '/save', // Go to /save route in python
            headers: {
                'Content-Type':'application/json' // pass as json
            },
            data: scoreData,
            dataType: 'json',
            method: 'POST',
            success: function (data) { // If successful, print success
                console.log("Success")
            },
            error: function (error) { // If not, print an error to the console
                console.log("Error with post");
            }
        });
    }) // end button click event
</script>

</body>
</html>
