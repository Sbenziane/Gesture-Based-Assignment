<!DOCTYPE HTML>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
crossorigin="anonymous">
</head>

<body>         
<h1>Game</h1>
    
      <div class="row align-items-center container-fluid">
    
        <div class="col-lg-5" style="min-height: 400px; padding-left: 60px; border-style: solid">
          <h2>Timer</h2>
          <button onclick="startTimer()">Start</button>
          <button onclick="stopTimer()">Stop</button>
          <p id="demo"></p>

          <form class="form-save" action="/save" method="post">
            <input type="text" id="savedUsername">
            <div>Your Score: <p id="savedTime"></p></div>
            <div><button type='button' id="saveScore" class="btn btn-block text-white" style="background: #9243D3;">Save</button></div>         
         </form>
        </div>
    
        <div class="col-lg-7">
          <div class="rounded" style="padding-right: 30px; padding-left: 30px; margin-right:50px; margin-top: 40px;">
          <h3>Scores</h3>
          <table id="topscores">
                <col width="30"><col width="150"><col width="40">
              <tr>
                <th>Rank</th><th>Username</th> <th>Score</th>
              </tr>
              <table id="tablecontent">
                    <col width="20"><col width="150"><col width="40">
                    <tr><td> 1</td><td id="u0"></td><td id="s0"></td></tr>                    
                    <tr><td> 2</td><td id="u1"></td><td id="s1"></td></tr>
                    <tr><td> 3</td><td id="u2"></td><td id="s2"></td></tr>
                    <tr><td> 4</td><td id="u3"></td><td id="s3"></td></tr>
                    <tr><td> 5</td><td id="u4"></td><td id="s4"></td></tr>
                    <tr><td> 6</td><td id="u5"></td><td id="s5"></td></tr>
                    <tr><td> 7</td><td id="u6"></td><td id="s6"></td></tr>
                    <tr><td> 8</td><td id="u7"></td><td id="s7"></td></tr>
                    <tr><td> 9</td><td id="u8"></td><td id="s8"></td></tr>
                    <tr><td>10</td><td id="u9"></td><td id="s9"></td></tr>
              </table>
          </table>       
          </div>
        </div>
    
      </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
    $( document ).ready(function() {
        console.log( "ready!" );
        checkUpdate();
    });
    $(function() {     
        setTimeout(checkUpdate, 1000);
    });

    function checkUpdate(){
        $.get("/getScoreList", function(data){
            d = JSON.parse(data);
            for (var i = 0; i < d.length; i++) {
                var utag = "u" + i;
                var stag = "s" + i;
                var username = d[i].username;
                var numScore = d[i].score;
                var len = numScore.length;
                var timeScore = numScore.substring(0, len-2) + ":" + numScore.substring(len-2);

                /* console.log("utag: " + utag + " , stag: " + stag);
                console.log("td: " + document.getElementById(utag).innerHTML + ", u: " + username);
                console.log("td: " + document.getElementById(stag).innerHTML + ", s: " + timeScore); */

                if(document.getElementById(utag).innerHTML != username && document.getElementById(stag).innerHTML != timeScore){
                    document.getElementById(utag).innerHTML = username;
                    document.getElementById(stag).innerHTML = timeScore;
                }
            }
            sortTable();
        });
        setTimeout(checkUpdate, 1000);
    }

/*
    function getTable(){
        $.get("/getScoreList", function(data){
            d = JSON.parse(data);
            for (var i = 0; i < d.length; i++) {
                var username = d[i].username;
                numScore = d[i].score;
                var len = numScore.length;
                var timeScore = numScore.substring(0, len-2) + ":" + numScore.substring(len-2);                 // Add : back in for time, just for readability - https://stackoverflow.com/a/5869593/7232648

                var tr = document.createElement('tr');
                var td0 = document.createElement('td');
                td0.appendChild(document.createTextNode(i + 1))
                tr.appendChild(td0)
                var td1 = document.createElement('td');
                td1.appendChild(document.createTextNode(username))
                tr.appendChild(td1)
                var td2 = document.createElement('td');
                td2.appendChild(document.createTextNode(timeScore))
                //td.setAttribute('rowSpan', '2') : null;
                tr.appendChild(td2)
                var element = document.getElementById("tablecontent");
                element.appendChild(tr);
            }
            sortTable();
        });
        setTimeout(getTable, 1000);
    }*/

    function sortTable() {
        var table, rows, switching, i, x, y, shouldSwitch;
        table = document.getElementById("topscores");
        switching = true;
        /*Make a loop that will continue until
        no switching has been done:*/
        while (switching) {
            //start by saying: no switching is done:
            switching = false;
            rows = table.getElementsByTagName("TR");
            /*Loop through all table rows (except the
            first, which contains table headers):*/
            for (i = 1; i < (rows.length - 1); i++) {
                //start by saying there should be no switching:
                shouldSwitch = false;
                /*Get the two elements you want to compare,
                one from current row and one from the next:*/
                x = rows[i].getElementsByTagName("TD")[1].innerHTML;
                var len1 = x.length;
                var timeScore1 = x.substring(0, len1-3) + x.substring(len1-2);
                y = rows[i + 1].getElementsByTagName("TD")[1].innerHTML;
                var len2 = y.length;
                var timeScore2 = y.substring(0, len2-3) + y.substring(len2-2);
                //check if the two rows should switch place:
                if (timeScore1 > timeScore2) {
                    //if so, mark as a switch and break the loop:
                    shouldSwitch= true;
                    break;
                }
            }
            if (shouldSwitch) {
                /*If a switch has been marked, make the switch
                and mark that a switch has been done:*/
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
            }
        }
    }
    
    var timerOn = 0;
    function timer() {
        if (timerOn == 1){
            // Set the time to count from - new Date() gets the current time
            var countDownDate = new Date().getTime();
            // Update the count down every 1 second
            x = setInterval(function() {
                // Get todays date and time
                var now = new Date().getTime();
                
                // Find the distance between now an the count down date
                var distance = now - countDownDate;
                
                // Time calculations for days, hours, minutes and seconds
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                // Output the result in an element with id="demo"
                document.getElementById("demo").innerHTML = minutes + ":" + pad(seconds, 2);
            }, 1000);
        }
    }

    function startTimer() {
        if (!timerOn) {
            timerOn = 1;
            timer();
        }
    }

    function stopTimer() {
        var time = document.getElementById("demo").innerHTML;
        document.getElementById("savedTime").innerHTML = time;
        clearTimeout(x);
        timerOn = 0;
        console.log(time);
    }

    // Pad seconds with 0s
    function pad(n, width, z) {
    z = z || '0';
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
    }

    // Button click event
    $('#saveScore').click(function ( event ){
        event.preventDefault(); // Cancels default action of click - https://api.jquery.com/event.preventdefault/

        if(document.getElementById("savedUsername").value == ""){
            givenusername = "anon";
        } else {
            givenusername = document.getElementById("savedUsername").value;
        }
        var scoreSec = document.getElementById("savedTime").innerHTML;
        var scoreNum = scoreSec.replace(":", "");

        // User's data in json
        var scoreData = {
            username: givenusername,
            score: scoreNum,
        }
        scoreData = JSON.stringify(scoreData)
        console.log("html json: " + scoreData)
        
        // Adapted from https://stackoverflow.com/a/26930355/7232648
        $.ajax({
            url: '/save',
            headers: {
                'Content-Type':'application/json' // pass as json
            },
            data: scoreData, // Turns whole json object into string
            dataType: 'json',
            method: 'POST',
            success: function (data) { // If successful, print "saved"]
                console.log("allscores: " + data.allscores)
                $('.topscores').text(data.allscores)
            },
            error: function (error) { // If not, print an error to the console
                //console.log("Error: " + error);
            }
        });
    }) // end button click event
</script>

</body>
</html>
