<!DOCTYPE HTML>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
crossorigin="anonymous">
</head>

<body>         
<h1>Game</h1>
    
      <div class="row align-items-center container-fluid">
    
        <div class="col-lg-5" style="min-height: 400px; padding-left: 60px; border-style: solid">
          <h2>Timer</h2>
          <button onclick="startTimer()">Start</button>
          <button onclick="stopTimer()">Stop</button>
          <p id="demo"></p>

          <form class="form-save" action="/save" method="post">
            <input type="text" id="savedUsername">
            <div>Your Score: <p id="savedTime"></p></div>
            <div><button type='button' id="saveScore" class="btn btn-block text-white" style="background: #9243D3;">Save</button></div>         
         </form>
        </div>
    
        <div class="col-lg-7">
          <div class="rounded" style="padding-right: 30px; padding-left: 30px; margin-right:50px; margin-top: 40px;">
          <h3>Scores</h3>
          <table id="topscores">
                <col width="150"><col width="60">
              <tr>
                <th>Username</th> <th>Score</th>
              </tr>
          </table>       
          </div>
        </div>
    
      </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
    $( document ).ready(function() {
        console.log( "ready!" );
        $.get("/getScoreList", function(data){
            d = JSON.parse(data);
            for (var i = 0, len = d.length; i < len; i++) {
                var username = d[i].username;
                //$('.username').text(username);
                console.log("username: " + d[i].username)
                numScore = d[i].score;
                var len = numScore.length;
                var timeScore = numScore.substring(0, len-2) + ":" + numScore.substring(len-2);                 // Add : back in for time, just for readability - https://stackoverflow.com/a/5869593/7232648
                console.log("score: " + timeScore)
                //$('.score').text(timeScore);


                var tr = document.createElement('tr');
                var td1 = document.createElement('td');
                td1.appendChild(document.createTextNode(username))
                tr.appendChild(td1)
                var td2 = document.createElement('td');
                td2.appendChild(document.createTextNode(timeScore))
                //td.setAttribute('rowSpan', '2') : null;
                tr.appendChild(td2)
                var element = document.getElementById("topscores");
                element.appendChild(tr);

                //tbdy.appendChild(tr);
                /*
                var el = document.createElement("TR");
                var node = document.createTextNode(username + ": " + timeScore)
                el.appendChild(node);
                var element = document.getElementById("topscores");
                element.appendChild(el);*/

            }
        });
    });

    var timerOn = 0;
    function timer() {
        if (timerOn == 1){
            // Set the time to count from - new Date() gets the current time
            var countDownDate = new Date().getTime();
            // Update the count down every 1 second
            x = setInterval(function() {
                // Get todays date and time
                var now = new Date().getTime();
                
                // Find the distance between now an the count down date
                var distance = now - countDownDate;
                
                // Time calculations for days, hours, minutes and seconds
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                // Output the result in an element with id="demo"
                document.getElementById("demo").innerHTML = minutes + ":" + pad(seconds, 2);
            }, 1000);
        }
    }

    function startTimer() {
        if (!timerOn) {
            timerOn = 1;
            timer();
        }
    }

    function stopTimer() {
        var time = document.getElementById("demo").innerHTML;
        document.getElementById("savedTime").innerHTML = time;
        clearTimeout(x);
        timerOn = 0;
        console.log(time);
    }

    // Pad seconds with 0s
    function pad(n, width, z) {
    z = z || '0';
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
    }

    // Button click event
    $('#saveScore').click(function ( event ){
        event.preventDefault(); // Cancels default action of click - https://api.jquery.com/event.preventdefault/

        if(document.getElementById("savedUsername").value == ""){
            givenusername = "anon";
        } else {
            givenusername = document.getElementById("savedUsername").value;
        }
        var scoreSec = document.getElementById("savedTime").innerHTML;
        var scoreNum = scoreSec.replace(":", "");

        // User's data in json
        var scoreData = {
            username: givenusername,
            score: scoreNum,
        }
        scoreData = JSON.stringify(scoreData)
        console.log("html json: " + scoreData)
        
        // Adapted from https://stackoverflow.com/a/26930355/7232648
        $.ajax({
            url: '/save',
            headers: {
                'Content-Type':'application/json' // pass as json
            },
            data: scoreData, // Turns whole json object into string
            dataType: 'json',
            method: 'POST',
            success: function (data) { // If successful, print "saved"]
                console.log("allscores: " + data.allscores)
                $('.topscores').text(data.allscores)
            },
            error: function (error) { // If not, print an error to the console
                //console.log("Error: " + error);
            }
        });
    }) // end button click event
</script>

</body>
</html>
