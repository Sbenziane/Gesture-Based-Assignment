<!DOCTYPE HTML>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb"
crossorigin="anonymous">
</head>

<body>         
<h1>Game</h1>
    
      <div class="row align-items-center container-fluid">
    
        <div class="col-lg-5" style="min-height: 400px; padding-left: 60px; border-style: solid">
          <h2>Timer</h2>
          <button onclick="startTimer()">Start</button>
          <button onclick="stopTimer()">Stop</button>
          <p id="demo"></p>

          <form class="form-save" action="/save" method="post">
            <input type="text" id="savedUsername">
            <div>Your Score: <p id="savedTime"></p></div>
            <div><button type='button' id="saveScore" class="btn btn-block text-white" style="background: #9243D3;">Save</button></div>         
         </form>
        </div>
    
        <div class="col-lg-7">
          <div class="rounded" style="padding-right: 30px; padding-left: 30px; margin-right:50px; margin-top: 40px;">
          <h4>Scores</h3>
            <td class = "topscores"></td>
          </div>
        </div>
    
      </div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
    var timerOn = 0;
    function timer() {
        if (timerOn == 1){
            // Set the time to count from - new Date() gets the current time
            var countDownDate = new Date().getTime();
            // Update the count down every 1 second
            x = setInterval(function() {
                // Get todays date and time
                var now = new Date().getTime();
                
                // Find the distance between now an the count down date
                var distance = now - countDownDate;
                
                // Time calculations for days, hours, minutes and seconds
                var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                var seconds = Math.floor((distance % (1000 * 60)) / 1000);
                
                // Output the result in an element with id="demo"
                document.getElementById("demo").innerHTML = minutes + ":" + pad(seconds, 2);
            }, 1000);
        }
    }

    function startTimer() {
        if (!timerOn) {
            timerOn = 1;
            timer();
        }
    }

    function stopTimer() {
        var time = document.getElementById("demo").innerHTML;
        document.getElementById("savedTime").innerHTML = time;
        clearTimeout(x);
        timerOn = 0;
        console.log(time);
    }

    // Pad seconds with 0s
    function pad(n, width, z) {
    z = z || '0';
    n = n + '';
    return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
    }

    /*// Get IP address
    var ipadd;
    $.getJSON('//freegeoip.net/json/?callback=?', function(data) {
        ipadd = data.ip;
    });*/

    // Button click event
    $('#saveScore').click(function ( event ){
        event.preventDefault(); // Cancels default action of click - https://api.jquery.com/event.preventdefault/

        // User's data in json
        var scoreData = {
            username: document.getElementById("savedUsername").value,
            score: document.getElementById("savedTime").innerHTML
        }
        scoreData = JSON.stringify(scoreData); 
        console.log("html json: " + scoreData)
        
        // Adapted from https://stackoverflow.com/a/26930355/7232648
        $.ajax({
            url: '/save',
            headers: {
                'Content-Type':'application/json' // pass as json
            },
            data: scoreData, // Turns whole json object into string
            dataType: 'json',
            method: 'POST',
            success: function (data) { // If successful, print "saved"]
                console.log("allscores: " + data.allscores)
                $('.topscores').text(data.allscores)
            },
            error: function (error) { // If not, print an error to the console
                console.log(error);
            }
            });
    }) // end button click event
</script>

</body>
</html>
