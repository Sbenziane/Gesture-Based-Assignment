<html>
    <head>
        <script>global=window</script>
        <style>
            .hidden{
                display:none;
            }
            canvas{
                padding: 0;
                margin: auto;
                display: block;
                width: 550px;
            }
        </style>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
        <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

        <script src='js/myo.js'></script>
        <script src='js/vector.myo.js'></script>
    </head>
    <body>
    <canvas id="game" width="550" height="450">
        Your browser does not support the HTML5 canvas tag.</canvas>
    <canvas id="game_wire" width="550" height="450" class="hidden"></canvas>
    <canvas id="game_start_box" width="550" height="450" class="hidden"></canvas>
    <canvas id="game_end_box" width="550" height="450" class="hidden"></canvas>
    <p id="demo"></p>
        <script>
        var on = false;
        var wire_data, start_box_data, end_box_data;
        var canvas = document.getElementById("game"), ctx = canvas.getContext("2d"), canvas_width = canvas.width, canvas_height = canvas.height;
            w_c = document.getElementById("game_wire"), w_ctx = w_c.getContext("2d"),
            s_c = document.getElementById("game_start_box"), s_ctx = s_c.getContext("2d"),
            e_c = document.getElementById("game_end_box"), e_ctx = e_c.getContext("2d");
        var start_x = 50, start_y = 50, end_x = 500, end_y = 50;
        var hoop_w_r = 20, hoop_h_r = 5;
        var pie_by_2 = 2 * Math.PI, pie_div_180 = Math.PI / 180; 
        ctx.lineWidth = 3 , ctx.strokeStyle = "#020202", w_ctx.lineWidth = 3, w_ctx.strokeStyle = "#020202";
        ctx.translate(0, canvas_height);
        ctx.scale(1, -1);
        w_ctx.translate(0, canvas_height);
        w_ctx.scale(1, -1);
        
        test = false;

        Myo.connect();

        // Set up game.
        // Draw wire and copy image data of just the wire in the canvas.
        // Then clear to draw properly.      
        get_game_data();
        new_game();
        
        Myo.on('connected', function(){
            myMyo = this;
		});
        Myo.on('fist', function(){
            on = true;
			this.zeroOrientation();
		});
        Myo.on('vector', _.throttle(function(vector){
            if(on){
                var xPos = (vector.x * 500) + start_x, yPos = (vector.y * 500) + start_y, zPos = vector.theta * 360;
                draw_game(xPos, yPos, zPos, hoop_w_r, hoop_h_r);
            }
		}, 50));
        function new_game(){
            on = false;
            draw_game(start_x, start_y, 0, hoop_w_r, hoop_h_r);
        }
        function win_game(){
            // Do win game stuff, like add score.
            new_game();
            alert("Whooo");
        }
        function lose_game(){
            // Buzz.
            new_game();
        }
        function draw_game(x, y, a, w_r, h_r){
            // Clear Canvas and draw game.
            ctx.clearRect(0, 0, canvas_width, canvas_height);
            extra_graphics();
            draw_wire(ctx);
            if(on)
                draw_hoop(x, y, a, w_r, h_r);
        }
        function get_img_data(c){
            // Get canvas data.
            return c.getImageData(0,0, canvas_width, canvas_height);
        }
        function draw_hoop(x1, y1, d1, w, h){
            ctx.beginPath();
            // Ref: https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/ellipse
            // Easier rotate with ellipse function.
            ctx.ellipse(x1, y1, h, w, (d1 + 90) * Math.PI/180, 0, 2 * Math.PI);
            ctx.stroke();
            ctx.closePath();

            // Calculate points on far edges for collsions.
            var d2 = (d1) * Math.PI / 180,
                d3 = (d1-180) * Math.PI / 180,
                x2 = x1 + w * Math.cos(d2),
                y2 = y1 + w * Math.sin(d2),
                x3 = x1 + w * Math.cos(d3),
                y3 = y1 + w * Math.sin(d3);
            
            // Check if in the ImageData object taken on at beginning of script.
            var p_1 = wire_data.data[(Math.round(canvas_height - y3) * (wire_data.width * 4)) + (Math.round(x3) * 4)],
                p_2 = wire_data.data[(Math.round(canvas_height - y2) * (wire_data.width * 4)) + (Math.round(x2) * 4)];
            
            if((p_1 != 0 && p_1 != undefined) || (p_2 != 0 && p_2 != undefined)) lose_game();
            // Check if the hoop has reached the end point.
            else if(e_ctx.isPointInPath(x1, y1)) win_game();
            // Check if out of bounds.
            else if(hoop_off_wire(x1, y1, x2, y2, x3, y3)) lose_game();
        }
        function hoop_off_wire(x1, y1, x2, y2, x3, y3){
            // Check points in the hidden canvas with only a wire on it.
            var res2 = w_ctx.isPointInPath(x2, canvas_height - y2), res3 = w_ctx.isPointInPath(x3, canvas_height - y3);
            
            if(s_ctx.isPointInPath(x1, y1)) {
                return false;
            } else if(res2 || res3){
                if(res2 && res3) return true;
                else return false;
            }else{
                if(w_ctx.isPointInPath(x1, canvas_height - y1)) return false;
                else return true;
            }
        }
        function draw_collision_box(c, x, y){
            c.beginPath();
            c.rect(x-hoop_w_r, y-hoop_w_r, hoop_w_r*2, hoop_w_r*1.5);
            c.stroke();
            c.closePath();
        }
        function draw_wire(c){
            // Drawn with Bezier Curves:
            // https://www.w3schools.com/tags/canvas_beziercurveto.asp
            c.beginPath();
            c.moveTo(50, 50);
            if(test){
                c.bezierCurveTo(50, 50, 50, 200, 140, 325);
                c.bezierCurveTo(140, 325, 250, 500, 390, 325);
                c.bezierCurveTo(390, 325, 500, 200, 500, 50);
            }else{
                c.bezierCurveTo(50, 50, 50, 200, 40, 300);
                c.bezierCurveTo(40, 300, 30, 400, 70, 350);
                c.bezierCurveTo(70, 350, 90, 325, 80, 300);
                c.bezierCurveTo(75, 290, 60, 240, 100, 240);
                c.bezierCurveTo(100, 240, 150, 240, 120, 300);
                c.bezierCurveTo(120, 300, 90, 350, 150, 300);
                c.bezierCurveTo(150, 300, 180, 275, 170, 250);
                c.bezierCurveTo(130, 180, 80, 125, 110, 130);
                c.bezierCurveTo(110, 130, 130, 135, 145, 120);
                c.bezierCurveTo(280, 0, 190, 190, 210, 300);
                c.bezierCurveTo(210, 300, 220, 350, 230, 300);
                c.bezierCurveTo(230, 300, 250, 150, 280, 200);
                c.bezierCurveTo(290, 220, 300, 260, 280, 300);
                c.bezierCurveTo(280, 300, 250, 360, 300, 380);
                c.bezierCurveTo(300, 380, 350, 400, 400, 380);
                c.bezierCurveTo(440, 360, 420, 320, 380, 280);
                c.bezierCurveTo(320, 220, 340, 240, 400, 220);
                c.bezierCurveTo(440, 200, 485, 415, 505, 365);
                c.bezierCurveTo(515, 325, 490, 200, 500, 50);
            }
            c.stroke();
            c.closePath();
        }
        function get_game_data(){
            draw_wire(w_ctx);
            wire_data = get_img_data(w_ctx);
            draw_collision_box(s_ctx, start_x, start_y);
            start_box_data = get_img_data(s_ctx);
            draw_collision_box(e_ctx, end_x, end_y);
            end_box_data = get_img_data(e_ctx);
        }
        function wire_holder(x, y, w, h, c){ 
            var w2 = w/2, h2 = h/2, 
                x1 = x - w2, y1 = y - h, 
                x2 = x + w2;
            // Body of cylinder.
            ctx.beginPath();
            ctx.moveTo(x1, y);
            ctx.lineTo(x1,y1-1);
            ctx.bezierCurveTo(x1,y1,x,y-c,x2,y1);
            ctx.fillStyle = "#a85114";
            ctx.fill();
            ctx.stroke();
            ctx.closePath();

            ctx.beginPath();
            ctx.moveTo(x2, y);
            ctx.lineTo(x2,y1-1);
            ctx.bezierCurveTo(x2,y1,x,y-c,x1,y1);
            ctx.fill();
            ctx.stroke();
            ctx.closePath();   
            // Oval on top.
            ctx.beginPath();
            ctx.ellipse(x, y, h2, w2, 90 * Math.PI/180, 0, 2 * Math.PI);
            ctx.fillStyle = "#f28b43";
            ctx.fill();
            ctx.stroke();
            ctx.closePath();
        }
        function extra_graphics(){
            // Left.
            wire_holder(start_x, start_y, 80, 20, 35);
            // Right.
            wire_holder(end_x, end_y, 80, 20, 35);
        }
        </script>
    </body>
</html>